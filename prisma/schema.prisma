// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  Int                  @id @default(autoincrement())
  email               String               @unique
  nom                 String?
  prenom              String?
  photo               String?
  googleId            String               @unique
  role                Role                 @default(AGENT)
  actif               Boolean              @default(true)
  division            Division?            @relation(fields: [divisionId], references: [id])
  divisionId          Int?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  expressionsDeBesoin ExpressionDeBesoin[]
  divisionDirigee     Division?            @relation("DivisionDirecteur")
  discussions         Discussion[]
}

model ExpressionDeBesoin {
  id           Int          @id @default(autoincrement())
  numero       String?
  titre        String
  division     Division     @relation(fields: [divisionId], references: [id])
  divisionId   Int
  service      Service?     @relation(fields: [serviceId], references: [id])
  serviceId    Int?
  dateCreation DateTime     @default(now())
  statut       StatutEB     @default(BROUILLON)
  createur     User         @relation(fields: [createurId], references: [id])
  createurId   Int
  lignes       LigneEB[]
  discussions  Discussion[]
  bonCommande  BonCommande?
}

model LigneEB {
  id            Int                @id @default(autoincrement())
  description   String
  quantite      Int
  justification String
  matiere       Matiere            @relation(fields: [matiereId], references: [id])
  matiereId     Int
  eb            ExpressionDeBesoin @relation(fields: [ebId], references: [id])
  ebId          Int
}

model Matiere {
  id             Int              @id @default(autoincrement())
  code           String           @unique
  designation    String
  type           TypeMatiere
  categorie      CategorieMatiere
  unite          UniteMesure
  valeurUnitaire Float?
  seuilAlerte    Int?
  actif          Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  lignes         LigneEB[]
}

enum Role {
  AGENT
  VALIDATEUR
  ADMIN
}

enum StatutEB {
  BROUILLON
  EN_ATTENTE
  VALIDE
  REFUSE
  PRIS_EN_CHARGE
}

enum TypeMatiere {
  CONSOMMABLE
  DURABLE
}

enum CategorieMatiere {
  INFORMATIQUE
  MOBILIER
  FOURNITURE
  VEHICULE
  EQUIPEMENT
  MATERIEL_MEDICAL
  PRODUIT_ENTRETIEN
  PAPETERIE
  AUTRE
}

enum UniteMesure {
  PIECE
  LOT
  BOITE
  PAQUET
  KG
  GRAMME
  LITRE
  MILLILITRE
  METRE
  METRE_CARRE
  CARTON
  PALETTE
}

model Division {
  id          Int                  @id @default(autoincrement())
  nom         String               @unique
  code        String               @unique
  directeur   User?                @relation("DivisionDirecteur", fields: [directeurId], references: [id])
  directeurId Int?                 @unique
  services    Service[]
  users       User[]
  expressions ExpressionDeBesoin[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model Service {
  id          Int                  @id @default(autoincrement())
  nom         String
  code        String
  division    Division             @relation(fields: [divisionId], references: [id])
  divisionId  Int
  expressions ExpressionDeBesoin[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([code, divisionId])
}

model Discussion {
  id           Int                @id @default(autoincrement())
  message      String
  auteur       User               @relation(fields: [auteurId], references: [id])
  auteurId     Int
  expression   ExpressionDeBesoin @relation(fields: [expressionId], references: [id], onDelete: Cascade)
  expressionId Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([expressionId])
  @@index([auteurId])
}

model BonCommande {
  id               Int                @id @default(autoincrement())
  numero           String             @unique
  expression       ExpressionDeBesoin @relation(fields: [expressionId], references: [id])
  expressionId     Int                @unique
  dateEmission     DateTime           @default(now())
  fournisseur      String?
  adresseLivraison String?
  tauxTVA          Float              @default(20.0)
  remise           Float              @default(0.0)
  observations     String?
  lignes           LigneBonCommande[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model LigneBonCommande {
  id            Int         @id @default(autoincrement())
  bonCommande   BonCommande @relation(fields: [bonCommandeId], references: [id], onDelete: Cascade)
  bonCommandeId Int
  description   String
  quantite      Int
  prixUnitaire  Float
  matiereCode   String
  matiereNom    String
  unite         String
}

enum StatutBonCommande {
  EN_ATTENTE
  VALIDE
  ANNULE
  LIVRE
}
